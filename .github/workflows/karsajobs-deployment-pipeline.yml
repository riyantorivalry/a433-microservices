name: Karsajobs Deployment

on: [push, pull_request]

jobs:
  lint-dockerfile:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Install and Run hadolint
      run: |
        sudo wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v2.7.0/hadolint-Linux-x86_64
        sudo chmod +x /bin/hadolint
        hadolint Dockerfile

  test-app:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.16

    - name: Install Dependencies
      run: go mod download

    - name: Run Unit Tests
      run: go test -v -short --count=1 $(go list ./...)

  build-app-karsajobs:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Set up Docker
      uses: docker/setup-buildx-action@v1

    - name: Build and Push Docker Image
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin ghcr.io
        docker buildx create --use
        docker buildx build --platform linux/amd64,linux/arm64 -t ghcr.io/riyantorivalry/karsajobs:latest .
        docker push ghcr.io/riyantorivalry/karsajobs:latest
